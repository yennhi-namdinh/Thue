<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tr·∫°ng Th√°i Thu√™ Qu·∫ßn √Åo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif}
body{background:#f6f7f8;color:#222}

/* HEADER */
header{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px;
  background:#111;
  color:#fff
}
.back{font-size:18px;cursor:pointer}
.marquee{overflow:hidden;white-space:nowrap;flex:1}
.marquee span{
  display:inline-block;
  padding-left:100%;
  animation:mar 8s linear infinite;
  font-weight:bold
}
@keyframes mar{
  0%{transform:translateX(0)}
  100%{transform:translateX(-100%)}
}

/* CONTENT */
.container{
  max-width:600px;
  margin:20px auto;
  padding:15px
}
h2{text-align:center;margin-bottom:8px}
.guide{text-align:center;font-size:14px;color:#666;margin-bottom:15px}

/* CARD */
.card{
  background:#fff;
  border-radius:12px;
  padding:12px;
  margin-bottom:15px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  display:flex;
  gap:12px;
  cursor:pointer
}
.card img{
  width:90px;
  height:120px;
  border-radius:8px;
  object-fit:cover
}
.info{flex:1;font-size:14px}
.info p{margin:4px 0}
.status{font-weight:bold;margin-top:6px}
.pending{color:orange}
.approved{color:green}
.rejected{color:red}
.time{font-size:12px;color:#777}

/* POPUP */
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999
}
.popup-box{
  background:#fff;
  width:92%;
  max-width:420px;
  border-radius:14px;
  padding:15px
}
.popup-box img{
  width:100%;
  border-radius:10px;
  margin-bottom:10px
}
.popup-box p{
  font-size:14px;
  margin:6px 0
}
.popup-actions{
  margin-top:12px;
  display:flex;
  gap:10px
}
.popup-actions button{
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:14px
}
.cancel{background:#dc3545;color:#fff}
.close{background:#aaa;color:#fff;border-radius:8px;margin-top:10px;width:100%}
.reason-btn{
  margin-top:6px;
  padding:4px 8px;
  font-size:12px;
  border-radius:6px;
  background:#e5e7eb;
  color:#111;
  border:none;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <div class="back" onclick="history.back()">‚Üê</div>
  <div class="marquee">
    <span> TRANG THEO D√ïI TR·∫†NG TH√ÅI THU√ä ƒê·ªí ‚Ä¢ TRANG THEO D√ïI TR·∫†NG TH√ÅI THU√ä ƒê·ªí ‚Ä¢ </span>
  </div>
</header>

<div class="container">
  <h2>TR·∫†NG TH√ÅI THU√ä QU·∫¶N √ÅO</h2>
  <div class="guide">B·∫•m v√†o ƒë∆°n ƒë·ªÉ xem chi ti·∫øt</div>
  <div id="list"></div>
</div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-box">
    <img id="pImg">
    <p><b>H·ªç t√™n:</b> <span id="pName"></span></p>
    <p><b>SƒêT:</b> <span id="pPhone"></span></p>
    <p><b>Gmail:</b> <span id="pGmail"></span></p>
    <p><b>ƒê·ªãa ch·ªâ:</b> <span id="pAddress"></span></p>
    <p><b>Size:</b> <span id="pSize"></span></p>
    <p><b>S·ªë l∆∞·ª£ng:</b> <span id="pQty"></span></p>
    <p><b>Ghi ch√∫:</b> <span id="pNote"></span></p>
    <p><b>Th·ªùi gian:</b> <span id="pTime"></span></p>
    <p class="status" id="pStatus"></p>

    <div class="popup-actions" id="cancelBox"></div>
    <button class="close" onclick="closePopup()">ƒê√≥ng</button>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  collection,
  onSnapshot,
  query,
  where,
  doc,
  getDoc,
  deleteDoc,
  orderBy
} from
"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";


/* DOM */
const list = document.getElementById("list");
const popup = document.getElementById("popup");
const pImg = document.getElementById("pImg");
const pName = document.getElementById("pName");
const pPhone = document.getElementById("pPhone");
const pGmail = document.getElementById("pGmail");
const pAddress = document.getElementById("pAddress");
const pSize = document.getElementById("pSize");
const pQty = document.getElementById("pQty");
const pNote = document.getElementById("pNote");
const pTime = document.getElementById("pTime");
const pStatus = document.getElementById("pStatus");
const cancelBox = document.getElementById("cancelBox");

let currentUser = null;
let currentOrderId = null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUser = user;
  loadOrders();
});

/* LOAD ORDERS */
function loadOrders(){
  const q = query(
  collection(db,"orders"),
  where("uid","==",currentUser.uid),
  orderBy("createdAt", "desc")
);
  

  onSnapshot(q,snap=>{
    list.innerHTML = "";

    if(snap.empty){
      list.innerHTML =
        "<p style='text-align:center;color:#777'>B·∫°n ch∆∞a c√≥ ƒë∆°n thu√™ n√†o</p>";
      return;
    }

snap.forEach(docu=>{
  const o = docu.data();

  // FIX STATUS
  let st = "pending";
  if(o.status === "approved") st = "approved";
  if(o.status === "rejected") st = "rejected";

  const time = o.createdAt?.toDate
    ? o.createdAt.toDate().toLocaleString("vi-VN")
    : "Kh√¥ng r√µ";

  // CH·ªà HI·ªÜN N√öT L√ù DO KHI B·ªä T·ª™ CH·ªêI
  const reasonBtn =
    st === "rejected"
      ? `<button class="reason-btn"
           onclick="event.stopPropagation();showReason('${docu.id}')">
           L√Ω do
         </button>`
      : "";

  list.innerHTML += `
    <div class="card" data-id="${docu.id}">
      <img src="${o.img || ""}">
      ${reasonBtn}
      <div class="info">
        <p><b>${o.name}</b></p>
        <p>Size ${o.size} ‚Ä¢ SL ${o.qty}</p>
        <p class="time">üïí ${time}</p>
        <div class="status ${st}">
          ${
            st==="pending"
              ? "Ch·ªù duy·ªát"
              : st==="approved"
              ? "ƒê√£ duy·ªát"
              : "T·ª´ ch·ªëi"
          }
        </div>
      </div>
    </div>
  `;
});
    

    document.querySelectorAll(".card").forEach(card=>{
      card.onclick = ()=>openPopup(card.dataset.id);
    });
  });
}

/* POPUP */
async function openPopup(id){
  currentOrderId = id;
  const snap = await getDoc(doc(db,"orders",id));
  const d = snap.data();

  pImg.src = d.img || "";
  pName.innerText = d.name;
  pPhone.innerText = d.phone;
  pGmail.innerText = d.gmail;
  pAddress.innerText = d.address;
  pSize.innerText = d.size;
  pQty.innerText = d.qty;
  pNote.innerText = d.note || "Kh√¥ng c√≥";
  pTime.innerText = d.createdAt?.toDate
    ? d.createdAt.toDate().toLocaleString("vi-VN")
    : "Kh√¥ng r√µ";

const st = d.status === "approved"
  ? "approved"
  : d.status === "rejected"
  ? "rejected"
  : "pending";
  pStatus.className = "status " + st;
pStatus.innerText =
  "Tr·∫°ng th√°i: " +
  (st==="pending"
    ? "Ch·ªù duy·ªát"
    : st==="approved"
    ? "ƒê√£ duy·ªát"
    : "T·ª´ ch·ªëi");
  

  cancelBox.innerHTML =
    st==="pending"
      ? `<button class="cancel" onclick="cancelOrder()">Thu h·ªìi</button>`
      : "";

  popup.style.display="flex";
}

/* CLOSE */
window.closePopup = ()=>{
  popup.style.display="none";
};

/* CANCEL */
window.cancelOrder = async ()=>{
  if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën thu h·ªìi ƒë∆°n n√†y?")) return;
  await deleteDoc(doc(db,"orders",currentOrderId));
  alert("ƒê√£ thu h·ªìi ƒë∆°n thu√™");
  popup.style.display="none";
};
const reasonPopup = document.getElementById("reasonPopup");
const reasonText = document.getElementById("reasonText");

window.showReason = async (id)=>{
  const snap = await getDoc(doc(db,"orders",id));
  const d = snap.data();
  reasonText.innerText = d.reason || "Admin ch∆∞a g·ª≠i l√Ω do";
  reasonPopup.style.display="flex";
};

window.closeReason = ()=>{
  reasonPopup.style.display="none";
};
</script>
<div class="popup" id="reasonPopup">
  <div class="popup-box">
    <h3>L√Ω do t·ª´ admin</h3>
    <p id="reasonText" style="margin:10px 0;color:#333"></p>
    <button class="close" onclick="closeReason()">ƒê√≥ng</button>
  </div>
</div>
</body>
</html>