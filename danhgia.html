<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ƒê√°nh gi√° Shop</title>

<style>
  body{
    font-family: Arial, sans-serif;
    background: #f7f7f7;
    padding: 20px;
  }

  .box{
    max-width: 450px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  h2{
    text-align:center;
    margin-bottom:10px;
  }

  textarea{
    width: 100%;
    height: 100px;
    padding: 12px;
    border-radius: 8px;
    border:1px solid #ddd;
    margin: 10px 0;
    resize: none;
  }

  button{
    width: 100%;
    padding: 12px;
    background: #ff4a6e;
    border:none;
    color:white;
    font-size:16px;
    border-radius:8px;
    cursor:pointer;
  }

  .star-box{
    text-align:center;
    margin: 10px 0;
  }
  .star{
    font-size:30px;
    cursor:pointer;
    color:#ccc;
    padding:3px;
  }
  .star.selected{
    color: gold;
  }

  .review{
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    margin-top: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    cursor: pointer;
  }

.filter-box {
  display: flex !important;
  justify-content: center !important;
  flex-wrap: wrap !important;
  gap: 8px !important;
  margin: 15px 0 !important;
}

.filter-btn {
  width: auto !important;
  flex: 0 0 auto !important;
  display: inline-block !important;
  padding: 6px 12px !important;
  background: #000 !important;
  border: 1px solid #ccc !important;
  border-radius: 8px !important;
  cursor: pointer !important;
  font-size: 14px !important;
  text-align: center !important;
}

.filter-btn.active {
  background: #ffd54f !important;
  font-weight: bold !important;
}

.meo{
  margin-right: 20px;
}

/* POPUP */
.popup-bg{
  position:fixed;
  left:0; top:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
}

.popup{
  background:white;
  width:85%;
  max-width:400px;
  padding:20px;
  border-radius:12px;
}

.close{
  float:right;
  cursor:pointer;
  font-size:20px;
}

</style>
</head>

<body>
<button onclick="window.location.href='index.html'"
        style="
          padding:10px 16px;
          background:#000;
          color:white;
          border:none;
          border-radius:8px;
          cursor:pointer;
          margin-bottom:15px;
        ">
  ‚¨Ö Quay v·ªÅ trang ch√≠nh
</button>
<div class="box">
  <h2>‚≠ê ƒê√°nh gi√° c·ª≠a h√†ng</h2>

  <div id="usernameShow" style="text-align:center; margin-bottom:10px; color:#555;">
    @khach
  </div>

  <label>Ch·ªçn s·ªë sao:</label>
  <div class="star-box" id="starSelect">
      <span class="star" data-value="1">‚òÖ</span>
      <span class="star" data-value="2">‚òÖ</span>
      <span class="star" data-value="3">‚òÖ</span>
      <span class="star" data-value="4">‚òÖ</span>
      <span class="star" data-value="5">‚òÖ</span>
  </div>

<div class="meo">
  <label>Nh·∫≠p ƒë√°nh gi√° c·ªßa b·∫°n:</label>
  <textarea id="reviewText" placeholder="H√£y chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n..."></textarea>

  <button id="sendBtn">G·ª≠i ƒë√°nh gi√°</button>

  <div id="msg" style="text-align:center;margin-top:10px;"></div>
</div>

<h3 style="text-align:center;margin-top:25px;">üìå C√°c ƒë√°nh gi√° g·∫ßn ƒë√¢y</h3>

<!-- FILTER -->
<div class="filter-box">
  <button class="filter-btn" data-filter="all">T·∫•t c·∫£</button>
  <button class="filter-btn" data-filter="1">1 sao</button>
  <button class="filter-btn" data-filter="2">2 sao</button>
  <button class="filter-btn" data-filter="3">3 sao</button>
  <button class="filter-btn" data-filter="4">4 sao</button>
  <button class="filter-btn" data-filter="5">5 sao</button>
</div>

<div id="reviewList" style="max-width:450px;margin:auto;"></div>


<!-- POPUP -->
<div class="popup-bg" id="popupBg">
  <div class="popup">
    <span class="close" id="closePopup">√ó</span>
    <h3>N·ªôi dung ƒë√°nh gi√°</h3>
    <p id="popupContent"></p>

    <h4>Ph·∫£n h·ªìi c·ªßa admin:</h4>
    <p id="popupAdmin"></p>

    <!-- Thu h·ªìi ƒë√°nh gi√° -->
    <button id="deleteReviewBtn" 
        style="margin-top:15px; padding:10px; width:100%;
               background:#ff3b30; color:#fff; border:none;
               border-radius:8px; cursor:pointer; display:none;">
        Thu h·ªìi ƒë√°nh gi√°
    </button>
  </div>
</div>

<!-- FIREBASE -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBhLH36Hz6TI6gmJJTHP1Dztrbdxi9VGGs",
  authDomain: "shopyennhi-6baae.firebaseapp.com",
  databaseURL: "https://shopyennhi-6baae-default-rtdb.firebaseio.com",
  projectId: "shopyennhi-6baae",
  storageBucket: "shopyennhi-6baae.firebasestorage.app",
  messagingSenderId: "67718854816",
  appId: "1:67718854816:web:41ad03300cca3dbe4031c5",
  measurementId: "G-C0SZ9D10WM"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    const email = user.email.split("@")[0];
    document.getElementById("usernameShow").textContent = "@" + email;
  }
});

/* ---------------- TIME FORMAT ---------------- */
function formatTime(timestamp){
  const date = new Date(timestamp);
  const d = String(date.getDate()).padStart(2,"0");
  const m = String(date.getMonth()+1).padStart(2,"0");
  const y = date.getFullYear();
  const h = String(date.getHours()).padStart(2,"0");
  const mi = String(date.getMinutes()).padStart(2,"0");
  return `${d}/${m}/${y} l√∫c ${h}:${mi}`;
}

/* ---------------- STAR SELECT ---------------- */
let selectedStars = 0;
document.querySelectorAll(".star").forEach(star=>{
  star.addEventListener("click", ()=>{
    selectedStars = star.dataset.value;
    document.querySelectorAll(".star").forEach(s=>s.classList.remove("selected"));
    for(let i=0;i<selectedStars;i++){
      document.querySelectorAll(".star")[i].classList.add("selected");
    }
  });
});

/* ---------------- SEND REVIEW ---------------- */
document.getElementById("sendBtn").onclick = () => {
  const text = document.getElementById("reviewText").value.trim();
  const username = document.getElementById("usernameShow").textContent.replace("@","") || "khach";

  if (selectedStars === 0){ alert("Vui l√≤ng ch·ªçn s·ªë sao!"); return; }
  if (!text){ alert("Vui l√≤ng nh·∫≠p n·ªôi dung ƒë√°nh gi√°!"); return; }

  push(ref(db, "reviews"), {
    username: username,
    stars: selectedStars,
    text: text,
    adminReply: "",
    time: Date.now(),
    email: currentUser ? currentUser.email : null
  });

  document.getElementById("msg").textContent = "‚úî C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°!";
  document.getElementById("reviewText").value = "";
  selectedStars = 0;
  document.querySelectorAll(".star").forEach(s=>s.classList.remove("selected"));
};

/* ---------------- FILTER ---------------- */
let currentFilter = "all";
document.querySelectorAll(".filter-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".filter-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentFilter = btn.dataset.filter;
    loadReviews();
  };
});

/* ---------------- LOAD REVIEWS ---------------- */
function loadReviews(){
  const reviewList = document.getElementById("reviewList");

  onValue(ref(db, "reviews"), snapshot=>{
    reviewList.innerHTML = "";

    let reviews = [];
    snapshot.forEach(child=>{
      reviews.push({ id: child.key, ...child.val() });
    });

    reviews.reverse();

    reviews.forEach(data=>{
      if (currentFilter !== "all" && data.stars != currentFilter) return;

      const div = document.createElement("div");
      div.className = "review";

      let stars = "‚≠ê".repeat(data.stars);

      div.innerHTML = `
        <b>@${data.username}</b> ‚Äî ${stars} <br>
        <small style="color:#777;">${formatTime(data.time)}</small>
        <p>${data.text}</p>
      `;

      div.onclick = ()=> openPopup(data);

      reviewList.appendChild(div);
    });
  });
}

loadReviews();

/* ---------------- POPUP ---------------- */
let currentOpenReview = null;

function openPopup(data){
  currentOpenReview = data;

  document.getElementById("popupContent").innerHTML =
    `<b>@${data.username}</b><br><br>${data.text}`;

  document.getElementById("popupAdmin").innerText =
      data.adminReply && data.adminReply.trim() !== ""
      ? data.adminReply
      : "Admin hi·ªán ch∆∞a tr·∫£ l·ªùi";

  const deleteBtn = document.getElementById("deleteReviewBtn");

  if (currentUser && currentUser.email && data.email === currentUser.email) {
    deleteBtn.style.display = "block";
  } else {
    deleteBtn.style.display = "none";
  }

  document.getElementById("popupBg").style.display = "flex";
}

document.getElementById("closePopup").onclick = ()=>{
  document.getElementById("popupBg").style.display = "none";
};

/* ---------------- DELETE REVIEW ---------------- */
document.getElementById("deleteReviewBtn").onclick = ()=>{
  if (!currentOpenReview) return;

  if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën thu h·ªìi ƒë√°nh gi√° n√†y kh√¥ng?")) {
    remove(ref(db, "reviews/" + currentOpenReview.id));
    alert("ƒê√£ thu h·ªìi ƒë√°nh gi√°.");
    document.getElementById("popupBg").style.display = "none";
  }
};

document.body.style.zoom = "243%";
</script>

</body>
</html>
