<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªì s∆° c√° nh√¢n</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif}
    body{
      min-height:100vh;
      background:linear-gradient(135deg,#ff758c,#ff7eb3);
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .box{
      background:#fff;
      width:100%;
      max-width:420px;
      padding:30px;
      border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    h1{
      text-align:center;
      margin-bottom:20px;
      color:#ff4a6e;
    }
    label{
      font-size:14px;
      color:#666;
      margin-bottom:5px;
      display:block;
    }
    .input-wrap{
      position:relative;
      margin-bottom:15px;
    }
    input{
      width:100%;
      padding:14px 40px 14px 14px;
      border-radius:10px;
      border:1px solid #ddd;
      font-size:15px;
      background:#f9f9f9;
    }
    input[disabled]{
      background:#f1f1f1;
      color:#999;
    }
    .eye{
      position:absolute;
      right:12px;
      top:50%;
      transform:translateY(-50%);
      cursor:pointer;
      font-size:16px;
      user-select:none;
    }
    .btn{
      width:100%;
      padding:14px;
      border:none;
      border-radius:10px;
      background:#ff4a6e;
      color:#fff;
      font-size:16px;
      cursor:pointer;
      margin-top:5px;
    }
    .btn.logout{
      background:#555;
      margin-top:10px;
    }
    .msg{
      text-align:center;
      font-size:14px;
      margin:10px 0;
      color:red;
    }
  </style>
</head>
<body>

<div class="box">
  <h1>H·ªì s∆°</h1>

  <div class="msg" id="msg"></div>

  <label>@Username</label>
  <input type="text" id="username" disabled>

  <label>T√™n hi·ªÉn th·ªã</label>
  <div class="input-wrap">
    <input type="text" id="name">
  </div>

  <label>Email</label>
  <input type="text" id="email" disabled>

  <label>M·∫≠t kh·∫©u</label>
  <div class="input-wrap">
    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    <span class="eye" id="togglePass">üëÅ</span>
  </div>

  <button class="btn" id="saveBtn">L∆∞u thay ƒë·ªïi</button>
  <button class="btn logout" id="logoutBtn">ƒêƒÉng xu·∫•t</button>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const msg = document.getElementById("msg");

  const usernameEl = document.getElementById("username");
  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");
  const passwordEl = document.getElementById("password");
  const togglePass = document.getElementById("togglePass");

  const saveBtn = document.getElementById("saveBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  let currentUid = "";

  // Hi·ªán / ·∫©n m·∫≠t kh·∫©u
  togglePass.onclick = () => {
    if(passwordEl.type === "password"){
      passwordEl.type = "text";
      togglePass.textContent = "üôà";
    } else {
      passwordEl.type = "password";
      togglePass.textContent = "üëÅ";
    }
  };

  // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    currentUid = user.uid;
    emailEl.value = user.email;

    // L·∫•y d·ªØ li·ªáu t·ª´ Firestore
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (snap.exists()) {
      const data = snap.data();
      usernameEl.value = data.username || "";
      nameEl.value = data.name || "";
    }
  });

  // L∆∞u thay ƒë·ªïi
  saveBtn.onclick = async () => {
    const newName = nameEl.value.trim();
    const newPass = passwordEl.value;

    if (!newName) {
      msg.textContent = "T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!";
      return;
    }

    try {
      // Ki·ªÉm tra tr√πng t√™n
      const querySnap = await getDocs(collection(db, "users"));
      let nameExist = false;

      querySnap.forEach((docItem) => {
        const d = docItem.data();
        if (d.name === newName && docItem.id !== currentUid) {
          nameExist = true;
        }
      });

      if (nameExist) {
        msg.textContent = "T√™n n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!";
        return;
      }

      // C·∫≠p nh·∫≠t t√™n
      await updateDoc(doc(db, "users", currentUid), {
        name: newName
      });

      // ƒê·ªïi m·∫≠t kh·∫©u n·∫øu c√≥ nh·∫≠p
      if (newPass.length >= 6) {
        await updatePassword(auth.currentUser, newPass);
      }

      msg.style.color = "green";
      msg.textContent = "C·∫≠p nh·∫≠t th√†nh c√¥ng!";
      passwordEl.value = "";

    } catch (e) {
      msg.textContent = "C√≥ l·ªói x·∫£y ra, th·ª≠ l·∫°i!";
    }
  };

  // ƒêƒÉng xu·∫•t
  logoutBtn.onclick = async () => {
    await signOut(auth);
    window.location.href = "login.html";
  };
</script>

</body>
</html>