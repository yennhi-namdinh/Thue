<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Đăng ký</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif}
body{
  min-height:100vh;
  background:linear-gradient(135deg,#ff758c,#ff7eb3);
  display:flex;
  justify-content:center;
  align-items:center;
}
.box{
  background:#fff;
  width:100%;
  max-width:400px;
  padding:30px;
  border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.2);
}
h1{text-align:center;margin-bottom:10px;color:#ff4a6e}
.guide{text-align:center;font-size:14px;margin-bottom:20px;color:#777}
.input{
  width:100%;
  padding:14px;
  margin-bottom:15px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:15px;
}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:#ff4a6e;
  color:#fff;
  font-size:16px;
  cursor:pointer;
}
.link{text-align:center;margin-top:15px;font-size:14px}
.link a{color:#ff4a6e;text-decoration:none;font-weight:bold}
#msg{text-align:center;margin-bottom:10px;color:red;font-size:14px}
</style>
</head>
<body>

<div class="box">
  <h1>Đăng ký</h1>
  <div class="guide">Tạo tài khoản mới</div>
  <div id="msg"></div>

  <input type="text" id="username" class="input" placeholder="@username">
  <input type="text" id="name" class="input" placeholder="Tên hiển thị">
  <input type="email" id="email" class="input" placeholder="Gmail">
  <input type="password" id="password" class="input" placeholder="Mật khẩu">
  <input type="password" id="confirm" class="input" placeholder="Xác nhận mật khẩu">
  <button class="btn" id="registerBtn">Đăng ký</button>

  <div class="link">
    Đã có tài khoản? <a href="login.html">Đăng nhập</a>
  </div>
</div><script type="module">
import { auth, db } from "./firebase.js";
import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import {
  setDoc,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const msg = document.getElementById("msg");

document.getElementById("registerBtn").onclick = async () => {
  msg.style.color = "red";
  msg.textContent = "";

  const username = document.getElementById("username").value.trim().toLowerCase();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const confirm = document.getElementById("confirm").value;

  if (!username || !name || !email || !password || !confirm) {
    msg.textContent = "Nhập đầy đủ thông tin!";
    return;
  }

  if (!username.startsWith("@")) {
    msg.textContent = "Username phải bắt đầu bằng @";
    return;
  }

  if (password !== confirm) {
    msg.textContent = "Mật khẩu không khớp!";
    return;
  }

  try {
    // ✅ Check trùng username (ổn định)
    const usernameRef = doc(db, "usernames", username);
    const usernameSnap = await getDoc(usernameRef);

    if (usernameSnap.exists()) {
      msg.textContent = "Username đã tồn tại!";
      return;
    }

    // ✅ Tạo tài khoản Auth
    const userCred = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCred.user;

    // ✅ Lưu username
    await setDoc(usernameRef, {
      uid: user.uid
    });

    // ✅ Lưu hồ sơ
    await setDoc(doc(db, "users", user.uid), {
      username,
      name,
      email,
      createdAt: new Date()
    });

    msg.style.color = "green";
    msg.textContent = "Đăng ký thành công!";

    setTimeout(() => {
      window.location.href = "login.html";
    }, 1000);

  } catch (err) {
    console.log(err);
    msg.textContent = err.message;
  }
};
</script>


</body>
</html>